{% extends "auctions/layout.html" %}

{% block body %}
    <h2>Listing: {{ listing.title }}</h2>

    {% if listing.image_url %}
        <img src="{{ listing.image_url }}" alt="{{ listing.title }}" style="max-height: 400px;">
    {% endif %}

    <p>{{ listing.description }}</p>
    
    <hr>
    <h4>Current Price: ${{ current_price }}</h4>
    
    {% if user.is_authenticated %}
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        
        <form action="{% url 'place_bid' listing.id %}" method="post">
            {% csrf_token %}
            <input type="number" name="bid_amount" step="0.01" placeholder="Bid Amount">
            <button type="submit" class="btn btn-primary">Place Bid</button>
        </form>
    {% endif %}

    <ul>
        <li><strong>Owner:</strong> {{ listing.owner }}</li>
        <li><strong>Category:</strong> {{ listing.category|default:"No Category Listed" }}</li>
        <li><strong>Status:</strong> 
            {% if listing.is_active %}
                {% if user == listing.owner %}
                    <form action="{% url 'close_auction' listing.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning">Close Auction</button>
                    </form>
                {% endif %}
            {% else %}
                <div class="alert alert-info">
                    This auction is closed. 
                    {% if winner == user %}
                        <strong>Congratulations! You won this auction!</strong>
                    {% elif winner %}
                        <strong>Winner: {{ winner.username }}</strong>
                    {% else %}
                        <strong>No bids were placed.</strong>
                    {% endif %}
                </div>
            {% endif %}
        </li>
    </ul>

    <hr>
    <div>
        {% if user.is_authenticated %}
            <form action="{% url 'toggle_watchlist' listing.id %}" method="post">
                {% csrf_token %}
                {% if user in listing.watchlist.all %}
                    <button type="submit" class="btn btn-danger">Remove from Watchlist</button>
                {% else %}
                    <button type="submit" class="btn btn-success">Add to Watchlist</button>
                {% endif %}
            </form>
        {% endif %}
    </div>

{% endblock %}